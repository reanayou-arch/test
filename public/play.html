<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Horror-Studio ‚Äî –ò–≥—Ä–∞</title>

  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: radial-gradient(#111, #000);
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      background: rgba(255,255,255,0.05);
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 75%;
      padding: 12px;
      border-radius: 16px;
      font-size: 16px;
      line-height: 1.3;
    }

    .bot {
      background: rgba(255,255,255,0.1);
      align-self: flex-start;
    }

    .user {
      background: darkred;
      align-self: flex-end;
    }

    footer {
      display: flex;
      padding: 10px;
      gap: 10px;
      background: rgba(255,255,255,0.05);
    }

    input {
      flex: 1;
      padding: 12px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
    }

    button {
      padding: 12px 18px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background: darkred;
      color: white;
    }

    .backBtn {
      width: 100%;
      background: #333;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<header id="title">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</header>

<div id="chat"></div>

<footer>
  <input id="input" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç...">
  <button onclick="send()">‚û§</button>
</footer>

<button class="backBtn" onclick="location.href='index.html'">
  ‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é
</button>

<script>
/* ===============================
   1) –ü–æ–ª—É—á–∞–µ–º story –∏–∑ URL
================================ */
const params = new URLSearchParams(window.location.search);
let storyIndex = params.get("story");

/* ===============================
   2) –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
================================ */
if (storyIndex === null || storyIndex === "") {
  alert("‚ùå –û—à–∏–±–∫–∞: –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.\n–í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –º–µ–Ω—é –∏ –Ω–∞–∂–º–∏—Ç–µ –ò–≥—Ä–∞—Ç—å.");
  location.href = "index.html";
}

/* ===============================
   3) –ü—Ä–∏–≤–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –∫ —á–∏—Å–ª—É
================================ */
storyIndex = Number(storyIndex);

/* ===============================
   4) –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ localStorage
================================ */
let stories = JSON.parse(localStorage.getItem("stories") || "[]");

/* ===============================
   5) –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏—Å—Ç–æ—Ä–∏–π
================================ */
if (!Array.isArray(stories) || stories.length === 0) {
  alert("‚ùå –í –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π.\n–°–æ–∑–¥–∞–π –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ '–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é'.");
  location.href = "index.html";
}

/* ===============================
   6) –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏
================================ */
if (!stories[storyIndex]) {
  alert(
    "‚ùå –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.\n\n" +
    "–ü—Ä–∏—á–∏–Ω—ã:\n" +
    "‚Ä¢ localStorage –æ—á–∏—â–µ–Ω\n" +
    "‚Ä¢ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ –¥—Ä—É–≥–æ–º –±—Ä–∞—É–∑–µ—Ä–µ\n" +
    "‚Ä¢ –∏–Ω–¥–µ–∫—Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π\n\n" +
    "–í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –º–µ–Ω—é."
  );
  location.href = "index.html";
}

/* ===============================
   7) –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
================================ */
const story = stories[storyIndex];

document.getElementById("title").innerText = "üìñ " + story.title;

const chat = document.getElementById("chat");

/* ===============================
   8) –ü–æ–∫–∞–∑ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Å—Ü–µ–Ω—ã
================================ */
addBot(story.startScene || "–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...");

/* ===============================
   –°–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
================================ */
function addBot(text) {
  const div = document.createElement("div");
  div.className = "msg bot";
  div.innerText = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function addUser(text) {
  const div = document.createElement("div");
  div.className = "msg user";
  div.innerText = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===============================
   9) –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
================================ */
async function send() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  addUser(text);
  input.value = "";

  addBot("...");

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama-3.1-8b-instant",
        messages: [
          {
            role: "system",
            content: "–¢—ã —Ö–æ—Ä—Ä–æ—Ä-—Ä–∞—Å—Å–∫–∞–∑—á–∏–∫. –ü—Ä–æ–¥–æ–ª–∂–∞–π –∏—Å—Ç–æ—Ä–∏—é –∏–≥—Ä–æ–∫–∞."
          },
          {
            role: "user",
            content: story.description + "\n\n–ù–∞—á–∞–ª–æ:\n" + story.startScene
          },
          {
            role: "user",
            content: text
          }
        ]
      })
    });

    const data = await res.json();

    chat.lastChild.remove();

    if (data.error) {
      addBot("‚ùå –û—à–∏–±–∫–∞: " + data.error);
      return;
    }

    addBot(data.choices[0].message.content);

  } catch (e) {
    chat.lastChild.remove();
    addBot("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.");
  }
}
</script>

</body>
</html>
