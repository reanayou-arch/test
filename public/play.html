<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Horror-Studio ‚Äî –ß–∞—Ç</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #1c1c1c;
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .topbar {
      height: 60px;
      background: #111;
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid #333;
    }

    /* –ß–∞—Ç */
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* –°–æ–æ–±—â–µ–Ω–∏–µ */
    .msg {
      max-width: 75%;
      padding: 12px 14px;
      border-radius: 18px;
      font-size: 16px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    /* NPC */
    .npc {
      align-self: flex-start;
      background: #2e2e2e;
      border-bottom-left-radius: 5px;
    }

    /* –ò–≥—Ä–æ–∫ */
    .me {
      align-self: flex-end;
      background: #007aff;
      border-bottom-right-radius: 5px;
    }

    /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
    .inputbar {
      height: 65px;
      display: flex;
      padding: 10px;
      background: #111;
      border-top: 1px solid #333;
    }

    input {
      flex: 1;
      border: none;
      border-radius: 20px;
      padding: 12px 15px;
      font-size: 16px;
      outline: none;
      background: #2a2a2a;
      color: white;
    }

    button {
      margin-left: 10px;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      background: #007aff;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }

    button:active {
      transform: scale(0.95);
    }
  </style>
</head>

<body>

  <!-- –í–µ—Ä—Ö -->
  <div class="topbar">
    Horror-Studio ‚Äî –ß–∞—Ç
  </div>

  <!-- –ß–∞—Ç -->
  <div class="chat" id="chat"></div>

  <!-- –í–≤–æ–¥ -->
  <div class="inputbar">
    <input id="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button onclick="send()">‚û§</button>
  </div>

<script>
/* ===========================
   –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
=========================== */

const chat = document.getElementById("chat");
const input = document.getElementById("input");

let storyData = null;

/* –ë–µ—Ä—ë–º story –∏–∑ URL */
const params = new URLSearchParams(window.location.search);
const storyFile = params.get("story");

/* –ë–µ—Ä—ë–º story –∏–∑ localStorage */
const localStory = localStorage.getItem("currentStory");

/* –ü—Ä–æ–≤–µ—Ä–∫–∞ */
if (!storyFile && !localStory) {
  addNPC("‚ùå –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –º–µ–Ω—é.");
} else {
  loadStory();
}

/* ===========================
   –ó–∞–≥—Ä—É–∑–∫–∞ JSON
=========================== */
async function loadStory() {

  /* –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ */
  if (localStory) {
    storyData = JSON.parse(localStory);
    startChat();
    return;
  }

  /* –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –ø–æ —Ñ–∞–π–ª—É */
  try {
    const res = await fetch("/stories/" + storyFile);
    storyData = await res.json();
    startChat();
  } catch (err) {
    addNPC("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏.");
  }
}

/* ===========================
   –°—Ç–∞—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏
=========================== */
function startChat() {
  addNPC("üìñ –ù–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏:");
  addNPC(storyData.startScene || "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞...");
}

/* ===========================
   –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
=========================== */
function addNPC(text) {
  const div = document.createElement("div");
  div.className = "msg npc";
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function addMe(text) {
  const div = document.createElement("div");
  div.className = "msg me";
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===========================
   –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–≥—Ä–æ–∫–∞
=========================== */
async function send() {
  const text = input.value.trim();
  if (!text) return;

  addMe(text);
  input.value = "";

  await aiReply(text);
}

/* ===========================
   –û—Ç–≤–µ—Ç –ò–ò (Groq)
=========================== */
async function aiReply(playerText) {

  addNPC("...");

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        model: "llama-3.1-8b-instant",
        messages: [
          {
            role: "system",
            content: `
–¢—ã ‚Äî —Ö–æ—Ä—Ä–æ—Ä —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫.
–ü—Ä–æ–¥–æ–ª–∂–∞–π –∏—Å—Ç–æ—Ä–∏—é —Å—Ç—Ä–æ–≥–æ –≤ —Å—Ç–∏–ª–µ —É–∂–∞—Å–∞.
–ù–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π —Ä–µ–∑–∫–æ.
–ò—Å—Ç–æ—Ä–∏—è: ${storyData.description}
`
          },
          { role: "user", content: playerText }
        ]
      })
    });

    const data = await res.json();

    /* —É–¥–∞–ª–∏—Ç—å "..." */
    chat.lastChild.remove();

    const answer =
      data.choices?.[0]?.message?.content ||
      "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò.";

    addNPC(answer);

  } catch (err) {
    chat.lastChild.remove();
    addNPC("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
  }
}

/* Enter –æ—Ç–ø—Ä–∞–≤–∫–∞ */
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") send();
});
</script>

</body>
</html>
