<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Horror-Studio ‚Äî –ß–∞—Ç</title>

  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: #111;
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 15px;
      background: #1c1c1c;
      font-size: 20px;
      font-weight: bold;
      border-bottom: 1px solid #333;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
      max-width: 75%;
      padding: 12px 15px;
      border-radius: 18px;
      font-size: 16px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    .bot {
      align-self: flex-start;
      background: #2a2a2a;
    }

    .user {
      align-self: flex-end;
      background: darkred;
    }

    footer {
      display: flex;
      padding: 10px;
      background: #1c1c1c;
      border-top: 1px solid #333;
    }

    input {
      flex: 1;
      padding: 12px;
      border-radius: 20px;
      border: none;
      outline: none;
      font-size: 16px;
    }

    button {
      margin-left: 10px;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 20px;
      cursor: pointer;
      background: darkred;
      color: white;
    }

    .backBtn {
      width: 100%;
      padding: 14px;
      border-radius: 15px;
      background: #333;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      font-size: 16px;
    }
  </style>
</head>

<body>

<header>Horror-Studio ‚Äî –ß–∞—Ç</header>

<div id="chat"></div>

<footer>
  <input id="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
  <button onclick="sendMsg()">‚û§</button>
</footer>

<button class="backBtn" onclick="location.href='index.html'">
  ‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é
</button>

<script>
/* ============================
   –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ localStorage
============================ */
const params = new URLSearchParams(location.search);
const localIndex = params.get("local");

const stories = JSON.parse(localStorage.getItem("horrorStories") || "[]");

const chat = document.getElementById("chat");

function addMessage(text, who) {
  const div = document.createElement("div");
  div.className = "msg " + who;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ============================
   –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
============================ */
if (localIndex === null || !stories[localIndex]) {
  addMessage("‚ùå –û—à–∏–±–∫–∞: –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.", "bot");
} else {
  const story = stories[localIndex];

  addMessage("üìñ –ù–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏:", "bot");
  addMessage(story.startScene || "–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞.", "bot");
}

/* ============================
   –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Groq
============================ */
async function sendMsg() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  addMessage(text, "user");
  input.value = "";

  addMessage("...", "bot");

  try {
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama-3.1-8b-instant",
        messages: [
          { role: "system", content: "–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–∂ —Ö–æ—Ä—Ä–æ—Ä-–∏—Å—Ç–æ—Ä–∏–∏. –û—Ç–≤–µ—á–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ." },
          { role: "user", content: text }
        ]
      })
    });

    const data = await response.json();

    chat.lastChild.remove();

    if (data.error) {
      addMessage("‚ùå –û—à–∏–±–∫–∞ Groq: " + data.error.message, "bot");
      return;
    }

    const reply = data.choices?.[0]?.message?.content;

    addMessage(reply || "‚ùå –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏.", "bot");

  } catch (err) {
    chat.lastChild.remove();
    addMessage("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.", "bot");
  }
}
</script>

</body>
</html>
